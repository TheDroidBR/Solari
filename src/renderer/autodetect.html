<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solari - Auto-Detec√ß√£o</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

        :root {
            --primary: #ff9966;
            --primary-dark: #ff5e62;
            --accent: #5865F2;
            --success: #4ade80;
            --warning: #ffbd2e;
            --danger: #ef4444;
            --bg-dark: #0f0c29;
            --bg-mid: #1a1a3e;
            --bg-light: #24243e;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            --text-dim: rgba(255, 255, 255, 0.4);
            --glow-primary: rgba(255, 153, 102, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) rgba(0, 0, 0, 0.2);
        }

        /* Modern Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--primary-dark));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-dark), var(--primary));
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        body {
            font-family: 'Outfit', 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-y: auto;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .container {
            width: 100%;
            height: 100%;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0c29 0%, #1a1a3e 50%, #16162a 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 0;
            padding: 28px;
            box-shadow: none;
            border: none;
        }

        @keyframes containerFadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, #ff7b54 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 40px var(--glow-primary);
        }

        .subtitle {
            text-align: center;
            color: var(--text-dim);
            margin-bottom: 28px;
            font-size: 0.9em;
        }

        .mapping-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .column {
            flex: 1;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.01) 100%);
            border-radius: 16px;
            padding: 18px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .column:hover {
            border-color: rgba(255, 255, 255, 0.12);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
        }

        .column h2 {
            font-size: 0.95em;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
            color: var(--primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preset-list,
        .mapping-list {
            list-style: none;
            max-height: 160px;
            overflow-y: auto;
            padding: 4px;
        }

        .preset-item,
        .mapping-item {
            padding: 12px 14px;
            margin-bottom: 6px;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preset-item:hover,
        .mapping-item:hover {
            background: rgba(255, 153, 102, 0.15);
            border-color: rgba(255, 153, 102, 0.3);
            transform: translateX(3px);
        }

        .preset-item.selected {
            background: linear-gradient(135deg, rgba(255, 153, 102, 0.25) 0%, rgba(255, 94, 98, 0.15) 100%);
            border: 1px solid var(--primary);
            box-shadow: 0 0 15px rgba(255, 153, 102, 0.2);
        }

        .mapping-item .delete-btn {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }

        .mapping-item .delete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .section-box {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.01) 100%);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 18px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .section-box:hover {
            border-color: rgba(255, 255, 255, 0.12);
        }

        .section-box h2 {
            font-size: 0.95em;
            margin-bottom: 14px;
            color: var(--success);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-box.fallback h2 {
            color: #60a5fa;
        }

        .section-box.website h2 {
            color: #c084fc;
        }

        .form-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.8em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .form-group input:hover,
        .form-group select:hover {
            border-color: rgba(255, 255, 255, 0.15);
            background: rgba(0, 0, 0, 0.35);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--glow-primary);
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 94, 98, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 123, 84, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-blue {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
        }

        .btn-blue:hover {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-purple {
            background: linear-gradient(135deg, #a855f7, #c084fc);
            color: white;
        }

        .btn-purple:hover {
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
        }

        .footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .hint {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 15px;
            color: #666;
            font-style: italic;
        }

        .arrow {
            font-size: 1.5em;
            color: #ff9966;
            display: flex;
            align-items: center;
        }

        .fallback-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .fallback-status.active {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .fallback-status.inactive {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: rgba(255, 123, 84, 0.2);
            border-color: #ff7b54;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéØ Auto-Detec√ß√£o</h1>
        <p class="subtitle">Configure presets para serem ativados automaticamente</p>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="apps">üì¶ Aplicativos</div>
            <div class="tab" data-tab="websites">üåê Sites (Navegador)</div>
        </div>

        <!-- Tab: Applications -->
        <div id="tab-apps" class="tab-content active">
            <!-- Fallback Preset -->
            <div class="section-box fallback">
                <h2>üîÑ Preset Padr√£o (Fallback)</h2>
                <p class="hint" style="margin-bottom: 10px;">Quando nenhum programa mapeado for detectado:</p>
                <div class="form-row">
                    <div class="form-group">
                        <select id="fallbackPresetSelect">
                            <option value="-1">Nenhum (manter √∫ltimo preset)</option>
                            <option value="-2">üö´ Desativar RPC (sem status)</option>
                        </select>
                    </div>
                    <button id="saveFallbackBtn" class="btn btn-blue">Salvar</button>
                    <span id="fallbackStatus" class="fallback-status inactive">N√£o configurado</span>
                </div>
            </div>

            <!-- Add New Mapping -->
            <div class="section-box">
                <h2>‚ûï Adicionar Mapeamento de Aplicativo</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Preset</label>
                        <select id="presetSelect">
                            <option value="">Selecione um preset...</option>
                        </select>
                    </div>
                    <span class="arrow">‚Üí</span>
                    <div class="form-group">
                        <label>Nome do Processo (ex: chrome.exe)</label>
                        <input type="text" id="processName" placeholder="nome_do_programa.exe" />
                    </div>
                    <button id="addMappingBtn" class="btn btn-primary">Adicionar</button>
                </div>
                <p class="hint">üí° Dica: Use o Gerenciador de Tarefas (Ctrl+Shift+Esc) para ver o nome do processo</p>
            </div>

            <!-- Current Mappings -->
            <div class="mapping-container">
                <div class="column">
                    <h2>üìã Mapeamentos de Aplicativos</h2>
                    <ul id="mappingList" class="mapping-list">
                        <li class="empty-state">Nenhum mapeamento configurado...</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Tab: Websites -->
        <div id="tab-websites" class="tab-content">
            <!-- Extension vs AutoDetect Toggle -->
            <div class="section-box"
                style="border-color: var(--primary); background: linear-gradient(135deg, rgba(255, 153, 102, 0.1) 0%, rgba(255, 94, 98, 0.05) 100%);">
                <h2 style="color: var(--primary);">üîå M√©todo de Detec√ß√£o</h2>
                <p class="hint" style="margin-bottom: 15px;">Escolha como detectar sites como YouTube, Netflix e Twitch:
                </p>

                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label class="radio-option" id="useExtensionOption"
                        style="flex: 1; min-width: 200px; padding: 15px; border-radius: 12px; border: 2px solid var(--glass-border); background: rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s;">
                        <input type="radio" name="webDetectionMethod" value="extension" id="useExtensionRadio"
                            style="margin-right: 10px;">
                        <strong style="color: var(--success);">üß© Usar Extens√£o</strong>
                        <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 5px;">
                            Detecta automaticamente o que voc√™ est√° assistindo no navegador.<br>
                            <em>Requer a extens√£o Solari instalada.</em>
                        </p>
                    </label>

                    <label class="radio-option" id="useAutoDetectOption"
                        style="flex: 1; min-width: 200px; padding: 15px; border-radius: 12px; border: 2px solid var(--glass-border); background: rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s;">
                        <input type="radio" name="webDetectionMethod" value="autodetect" id="useAutoDetectRadio"
                            style="margin-right: 10px;">
                        <strong style="color: #c084fc;">üåê Usar Auto-Detec√ß√£o</strong>
                        <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 5px;">
                            Detecta por palavra-chave no t√≠tulo da janela.<br>
                            <em>N√£o requer extens√£o.</em>
                        </p>
                    </label>
                </div>
            </div>

            <!-- AutoDetect Website Settings (hidden when using extension) -->
            <div id="autoDetectWebsiteSettings">
                <div class="section-box website">
                    <h2>üåê Detec√ß√£o de Sites no Navegador</h2>
                    <p class="hint" style="margin-bottom: 10px;">Detecta palavras-chave no t√≠tulo da janela do navegador
                        (Brave, Chrome, Edge, etc.)</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Preset</label>
                            <select id="websitePresetSelect">
                                <option value="">Selecione um preset...</option>
                            </select>
                        </div>
                        <span class="arrow">‚Üí</span>
                        <div class="form-group">
                            <label>Palavra-chave no t√≠tulo (ex: Netflix, YouTube)</label>
                            <input type="text" id="websiteKeyword" placeholder="Netflix" />
                        </div>
                        <button id="addWebsiteMappingBtn" class="btn btn-purple">Adicionar</button>
                    </div>
                    <p class="hint">üí° Quando voc√™ abrir Netflix no navegador, o t√≠tulo ser√° "Netflix - Brave" e ser√°
                        detectado!</p>
                </div>

                <!-- Website Mappings -->
                <div class="mapping-container">
                    <div class="column">
                        <h2>üìã Mapeamentos de Sites</h2>
                        <ul id="websiteMappingList" class="mapping-list">
                            <li class="empty-state">Nenhum mapeamento de site configurado...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Extension Info (shown when using extension) -->
            <div id="extensionInfo" style="display: none;">
                <div class="section-box"
                    style="border-color: var(--success); background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(74, 222, 128, 0.02) 100%);">
                    <h2 style="color: var(--success);">‚úÖ Modo Extens√£o Ativo</h2>
                    <p style="margin-bottom: 15px;">A extens√£o do Solari detectar√° automaticamente o que voc√™ est√°
                        assistindo no YouTube, Netflix e Twitch.</p>
                    <p class="hint">‚ö†Ô∏è O Auto-Detect de sites est√° desativado enquanto o modo extens√£o est√° ativo.</p>
                    <p class="hint" style="margin-top: 10px;">üí° Se a extens√£o n√£o estiver instalada, <a
                            href="https://chromewebstore.google.com/detail/ekhlmpampeikcibfdmokiibgdcfendgp"
                            target="_blank" id="getExtensionLink" style="color: var(--primary);">clique aqui para
                            baixar</a>.</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <button id="closeBtn" class="btn btn-secondary">Fechar</button>
        </div>
    </div>

    <script>
        console.log('[AutoDetect] ========== SCRIPT START ==========');
        const { ipcRenderer, shell } = require('electron');
        const path = require('path');
        const fs = require('fs');

        // Local translations for autodetect window
        let translations = {};

        function loadTranslationsLocal(lang) {
            try {
                const localePath = path.join(__dirname, 'locales', `${lang}.json`);
                const data = fs.readFileSync(localePath, 'utf-8');
                translations = JSON.parse(data);
                console.log('[AutoDetect] Loaded translations for:', lang);
            } catch (error) {
                console.error('[AutoDetect] Failed to load translations:', error);
                // Fallback to English
                if (lang !== 'en') {
                    loadTranslationsLocal('en');
                }
            }
        }

        function t(key) {
            const keys = key.split('.');
            let value = translations;
            for (const k of keys) {
                if (value && value[k] !== undefined) {
                    value = value[k];
                } else {
                    return key; // Return key if translation not found
                }
            }
            return value;
        }

        // Elements
        const presetSelect = document.getElementById('presetSelect');
        const websitePresetSelect = document.getElementById('websitePresetSelect');
        const fallbackPresetSelect = document.getElementById('fallbackPresetSelect');
        const processNameInput = document.getElementById('processName');
        const websiteKeywordInput = document.getElementById('websiteKeyword');
        const addMappingBtn = document.getElementById('addMappingBtn');
        const addWebsiteMappingBtn = document.getElementById('addWebsiteMappingBtn');
        const saveFallbackBtn = document.getElementById('saveFallbackBtn');
        const mappingList = document.getElementById('mappingList');
        const websiteMappingList = document.getElementById('websiteMappingList');
        const closeBtn = document.getElementById('closeBtn');
        const fallbackStatus = document.getElementById('fallbackStatus');
        const tabs = document.querySelectorAll('.tab');

        // New elements for Extension/AutoDetect toggle
        const useExtensionRadio = document.getElementById('useExtensionRadio');
        const useAutoDetectRadio = document.getElementById('useAutoDetectRadio');
        const useExtensionOption = document.getElementById('useExtensionOption');
        const useAutoDetectOption = document.getElementById('useAutoDetectOption');
        const autoDetectWebsiteSettings = document.getElementById('autoDetectWebsiteSettings');
        const extensionInfo = document.getElementById('extensionInfo');

        // State
        let currentMappings = [];
        let websiteMappings = [];
        let presets = [];
        let fallbackPresetIndex = -1;
        let useExtensionForWeb = true; // Default: use extension

        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
            });
        });

        // Register data handler FIRST (before requesting data)
        ipcRenderer.on('autodetect-data-loaded', (event, data) => {
            console.log('[AutoDetect] Data received:', data);
            console.log('[AutoDetect] App mappings:', data.mappings?.length || 0);
            console.log('[AutoDetect] Website mappings:', data.websiteMappings?.length || 0);
            console.log('[AutoDetect] Use extension for web:', data.useExtensionForWeb);
            presets = data.presets || [];
            currentMappings = data.mappings || [];
            websiteMappings = data.websiteMappings || [];
            fallbackPresetIndex = data.fallbackPresetIndex !== undefined ? data.fallbackPresetIndex : -1;
            useExtensionForWeb = data.useExtensionForWeb !== undefined ? data.useExtensionForWeb : true;
            renderPresets();
            renderMappings();
            renderWebsiteMappings();
            updateFallbackStatus();
            updateToggleUI();
        });

        // Initialize i18n FIRST - load translations before requesting data
        ipcRenderer.invoke('get-current-language').then((lang) => {
            console.log('[AutoDetect] Got language from main:', lang);
            loadTranslationsLocal(lang || 'en');
            updateUILanguage();
            // NOW request data after translations are ready AND handler is registered
            console.log('[AutoDetect] Requesting data...');
            ipcRenderer.send('get-autodetect-data');
        }).catch(() => {
            console.log('[AutoDetect] Failed to get language, using fallback');
            loadTranslationsLocal('en');
            updateUILanguage();
            ipcRenderer.send('get-autodetect-data');
        });

        function renderPresets() {
            // Main preset select
            presetSelect.innerHTML = `<option value="">${t('autoDetect.selectPreset') || t('smartAfk.selectPreset')}</option>`;
            websitePresetSelect.innerHTML = `<option value="">${t('autoDetect.selectPreset') || t('smartAfk.selectPreset')}</option>`;
            presets.forEach((preset, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = preset.name;
                presetSelect.appendChild(option);
                websitePresetSelect.appendChild(option.cloneNode(true));
            });

            // Fallback preset select
            fallbackPresetSelect.innerHTML = `<option value="-1">${t('autoDetect.keepLastPreset')}</option><option value="-2">${t('autoDetect.disableRpc')}</option>`;
            presets.forEach((preset, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = preset.name;
                fallbackPresetSelect.appendChild(option);
            });

            // Set current fallback value
            fallbackPresetSelect.value = fallbackPresetIndex;
        }

        function updateFallbackStatus() {
            if (fallbackPresetIndex === -2) {
                fallbackStatus.textContent = `${t('autoDetect.active')}: ${t('autoDetect.disableRpc')}`;
                fallbackStatus.className = 'fallback-status active';
                fallbackStatus.style.color = '#ef4444';
            } else if (fallbackPresetIndex >= 0 && presets[fallbackPresetIndex]) {
                fallbackStatus.textContent = `${t('autoDetect.active')}: ${presets[fallbackPresetIndex].name}`;
                fallbackStatus.className = 'fallback-status active';
                fallbackStatus.style.color = '';
            } else {
                fallbackStatus.textContent = t('autoDetect.notConfigured') || 'Not configured';
                fallbackStatus.className = 'fallback-status inactive';
                fallbackStatus.style.color = '';
            }
        }

        function renderMappings() {
            if (currentMappings.length === 0) {
                mappingList.innerHTML = `<li class="empty-state">${t('autoDetect.noMappings')}</li>`;
                return;
            }

            mappingList.innerHTML = '';
            currentMappings.forEach((mapping, index) => {
                const li = document.createElement('li');
                li.className = 'mapping-item';
                li.innerHTML = `
                    <span><strong>${mapping.presetName}</strong> ‚Üí ${mapping.processName}</span>
                    <button class="delete-btn" data-index="${index}" data-type="app">‚úñ</button>
                `;
                mappingList.appendChild(li);
            });
        }

        function renderWebsiteMappings() {
            if (websiteMappings.length === 0) {
                websiteMappingList.innerHTML = `<li class="empty-state">${t('autoDetect.noWebsiteMappings')}</li>`;
                return;
            }

            websiteMappingList.innerHTML = '';
            websiteMappings.forEach((mapping, index) => {
                const li = document.createElement('li');
                li.className = 'mapping-item';
                li.innerHTML = `
                    <span><strong>${mapping.presetName}</strong> ‚Üí "${mapping.keyword}"</span>
                    <button class="delete-btn" data-index="${index}" data-type="website">‚úñ</button>
                `;
                websiteMappingList.appendChild(li);
            });
        }

        // Toggle UI between Extension and AutoDetect modes
        function updateToggleUI() {
            if (useExtensionForWeb) {
                useExtensionRadio.checked = true;
                useAutoDetectRadio.checked = false;
                useExtensionOption.style.borderColor = 'var(--success)';
                useExtensionOption.style.background = 'rgba(74, 222, 128, 0.15)';
                useAutoDetectOption.style.borderColor = 'var(--glass-border)';
                useAutoDetectOption.style.background = 'rgba(0,0,0,0.2)';
                autoDetectWebsiteSettings.style.display = 'none';
                extensionInfo.style.display = 'block';
            } else {
                useExtensionRadio.checked = false;
                useAutoDetectRadio.checked = true;
                useExtensionOption.style.borderColor = 'var(--glass-border)';
                useExtensionOption.style.background = 'rgba(0,0,0,0.2)';
                useAutoDetectOption.style.borderColor = '#c084fc';
                useAutoDetectOption.style.background = 'rgba(192, 132, 252, 0.15)';
                autoDetectWebsiteSettings.style.display = 'block';
                extensionInfo.style.display = 'none';
            }
        }

        // Radio button event handlers
        useExtensionRadio.addEventListener('change', () => {
            if (useExtensionRadio.checked) {
                useExtensionForWeb = true;
                ipcRenderer.send('set-use-extension-for-web', true);
                updateToggleUI();
            }
        });

        useAutoDetectRadio.addEventListener('change', () => {
            if (useAutoDetectRadio.checked) {
                useExtensionForWeb = false;
                ipcRenderer.send('set-use-extension-for-web', false);
                updateToggleUI();
            }
        });

        // Use event delegation - add handlers ONCE to parent elements
        mappingList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const index = parseInt(e.target.dataset.index);
                if (!isNaN(index)) {
                    currentMappings.splice(index, 1);
                    ipcRenderer.send('save-autodetect-mappings', currentMappings);
                    renderMappings();
                }
            }
        });

        websiteMappingList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const index = parseInt(e.target.dataset.index);
                if (!isNaN(index)) {
                    websiteMappings.splice(index, 1);
                    ipcRenderer.send('save-website-mappings', websiteMappings);
                    renderWebsiteMappings();
                }
            }
        });

        // Add app mapping
        addMappingBtn.addEventListener('click', () => {
            const presetIndex = presetSelect.value;
            const processName = processNameInput.value.trim();

            if (!presetIndex || !processName) {
                alert(t('autoDetect.alertSelectPreset'));
                return;
            }

            const preset = presets[parseInt(presetIndex)];
            const newMapping = {
                presetName: preset.name,
                presetIndex: parseInt(presetIndex),
                processName: processName.toLowerCase()
            };

            const exists = currentMappings.some(m => m.processName === newMapping.processName);
            if (exists) {
                alert(t('autoDetect.alertExists'));
                return;
            }

            currentMappings.push(newMapping);
            ipcRenderer.send('save-autodetect-mappings', currentMappings);
            presetSelect.value = '';
            processNameInput.value = '';
            renderMappings();
        });

        // Add website mapping
        addWebsiteMappingBtn.addEventListener('click', () => {
            const presetIndex = websitePresetSelect.value;
            const keyword = websiteKeywordInput.value.trim();

            if (!presetIndex || !keyword) {
                alert(t('autoDetect.alertSelectPreset'));
                return;
            }

            const preset = presets[parseInt(presetIndex)];
            const newMapping = {
                presetName: preset.name,
                presetIndex: parseInt(presetIndex),
                keyword: keyword.toLowerCase()
            };

            const exists = websiteMappings.some(m => m.keyword === newMapping.keyword);
            if (exists) {
                alert(t('autoDetect.alertExists'));
                return;
            }

            websiteMappings.push(newMapping);
            ipcRenderer.send('save-website-mappings', websiteMappings);
            websitePresetSelect.value = '';
            websiteKeywordInput.value = '';
            renderWebsiteMappings();
        });

        saveFallbackBtn.addEventListener('click', () => {
            fallbackPresetIndex = parseInt(fallbackPresetSelect.value);
            ipcRenderer.send('save-fallback-preset', fallbackPresetIndex);
            updateFallbackStatus();

            saveFallbackBtn.textContent = t('autoDetect.saved');
            setTimeout(() => saveFallbackBtn.textContent = t('autoDetect.save'), 1500);
        });

        closeBtn.addEventListener('click', () => {
            window.close();
        });

        // i18n - Update UI language
        function updateUILanguage() {
            console.log('[AutoDetect] updateUILanguage called');
            try {
                // Title - using correct selectors
                const titleH1 = document.querySelector('.container > h1');
                const subtitle = document.querySelector('.subtitle');
                if (titleH1) titleH1.textContent = 'üéØ ' + t('autoDetect.title');
                if (subtitle) subtitle.textContent = t('autoDetect.subtitle');

                // Tabs
                const tabApps = document.querySelector('[data-tab="apps"]');
                const tabWebsites = document.querySelector('[data-tab="websites"]');
                if (tabApps) tabApps.innerHTML = 'üì¶ ' + t('autoDetect.applications');
                if (tabWebsites) tabWebsites.innerHTML = 'üåê ' + t('autoDetect.websites');

                // Close button
                if (closeBtn) closeBtn.textContent = t('autoDetect.close');

                // Fallback section
                const fallbackH2 = document.querySelector('.section-box.fallback h2');
                const fallbackHint = document.querySelector('.section-box.fallback .hint');
                if (fallbackH2) fallbackH2.textContent = 'üîÑ ' + t('autoDetect.fallbackPreset');
                if (fallbackHint) fallbackHint.textContent = t('autoDetect.fallbackHint');
                if (saveFallbackBtn) saveFallbackBtn.textContent = t('autoDetect.save');

                // Add Mapping section (apps)
                const addMappingH2 = document.querySelector('#tab-apps .section-box:not(.fallback) h2');
                if (addMappingH2) addMappingH2.textContent = '‚ûï ' + t('autoDetect.addMapping');

                const presetLabel = document.querySelector('#tab-apps .section-box:not(.fallback) label');
                if (presetLabel) presetLabel.textContent = t('autoDetect.preset');

                const processLabel = document.querySelector('#tab-apps input#processName')?.previousElementSibling;
                if (processLabel) processLabel.textContent = t('autoDetect.processName');

                // Update input placeholder
                const processInput = document.getElementById('processName');
                if (processInput) processInput.placeholder = t('autoDetect.processPlaceholder');

                // Update select dropdown default option
                const presetSelectOption = document.querySelector('#presetSelect option[value=""]');
                if (presetSelectOption) presetSelectOption.textContent = t('autoDetect.selectPreset');
                const websitePresetSelectOption = document.querySelector('#websitePresetSelect option[value=""]');
                if (websitePresetSelectOption) websitePresetSelectOption.textContent = t('autoDetect.selectPreset');

                if (addMappingBtn) addMappingBtn.textContent = t('autoDetect.add') || 'Adicionar';

                const appHint = document.querySelector('#tab-apps .section-box:not(.fallback) .hint');
                if (appHint) appHint.innerHTML = 'üí° ' + t('autoDetect.taskManagerHint');

                // Application mappings section
                const appMappingsH2 = document.querySelector('#tab-apps .mapping-container h2');
                if (appMappingsH2) appMappingsH2.textContent = 'üìã ' + t('autoDetect.applicationMappings');

                // Website section
                const websiteH2 = document.querySelector('.section-box.website h2');
                if (websiteH2) websiteH2.textContent = 'üåê ' + t('autoDetect.websiteDetection');

                const websiteHintFirst = document.querySelector('.section-box.website > .hint');
                if (websiteHintFirst) websiteHintFirst.textContent = t('autoDetect.websiteDetectionHint');

                const keywordLabel = document.querySelector('#websiteKeyword')?.previousElementSibling;
                if (keywordLabel) keywordLabel.textContent = t('autoDetect.keyword');

                // Update website keyword input placeholder
                const keywordInput = document.getElementById('websiteKeyword');
                if (keywordInput) keywordInput.placeholder = t('autoDetect.keywordPlaceholder');

                if (addWebsiteMappingBtn) addWebsiteMappingBtn.textContent = t('autoDetect.add') || 'Adicionar';

                const websiteHintLast = document.querySelectorAll('.section-box.website .hint')[1];
                if (websiteHintLast) websiteHintLast.innerHTML = 'üí° ' + t('autoDetect.websiteHint');

                // Website mappings section
                const webMappingsH2 = document.querySelector('#tab-websites .mapping-container h2');
                if (webMappingsH2) webMappingsH2.textContent = 'üìã ' + t('autoDetect.websiteMappings');

                // Detection Method section (new translations)
                const detectionMethodH2 = document.querySelector('#tab-websites > .section-box:first-child h2');
                if (detectionMethodH2) detectionMethodH2.innerHTML = 'üîå ' + t('autoDetect.detectionMethod');

                const detectionMethodHint = document.querySelector('#tab-websites > .section-box:first-child > .hint');
                if (detectionMethodHint) detectionMethodHint.textContent = t('autoDetect.detectionMethodHint');

                // Use Extension option
                const useExtensionStrong = document.querySelector('#useExtensionOption strong');
                if (useExtensionStrong) useExtensionStrong.innerHTML = 'üß© ' + t('autoDetect.useExtension');

                const useExtensionP = document.querySelector('#useExtensionOption p');
                if (useExtensionP) useExtensionP.innerHTML = t('autoDetect.useExtensionHint') + '<br><em>' + t('autoDetect.useExtensionNote') + '</em>';

                // Use Auto-Detection option
                const useAutoDetectStrong = document.querySelector('#useAutoDetectOption strong');
                if (useAutoDetectStrong) useAutoDetectStrong.innerHTML = 'üåê ' + t('autoDetect.useAutoDetect');

                const useAutoDetectP = document.querySelector('#useAutoDetectOption p');
                if (useAutoDetectP) useAutoDetectP.innerHTML = t('autoDetect.useAutoDetectHint') + '<br><em>' + t('autoDetect.useAutoDetectNote') + '</em>';

                // Extension Mode Active section
                const extensionInfoH2 = document.querySelector('#extensionInfo .section-box h2');
                if (extensionInfoH2) extensionInfoH2.innerHTML = '‚úÖ ' + t('autoDetect.extensionModeActive');

                const extensionInfoP = document.querySelector('#extensionInfo .section-box > p:first-of-type');
                if (extensionInfoP) extensionInfoP.textContent = t('autoDetect.extensionModeDescription');

                const extensionInfoHint1 = document.querySelector('#extensionInfo .section-box .hint:first-of-type');
                if (extensionInfoHint1) extensionInfoHint1.innerHTML = '‚ö†Ô∏è ' + t('autoDetect.extensionDisabledNotice');

                const getExtensionLink = document.getElementById('getExtensionLink');
                if (getExtensionLink) getExtensionLink.textContent = t('autoDetect.getExtensionLink');

                const extensionInfoHint2 = document.querySelector('#extensionInfo .section-box .hint:last-of-type');
                if (extensionInfoHint2 && getExtensionLink) {
                    extensionInfoHint2.innerHTML = 'üí° ' + t('autoDetect.extensionNotInstalled') + ' <a href="https://chromewebstore.google.com/detail/ekhlmpampeikcibfdmokiibgdcfendgp" target="_blank" id="getExtensionLink" style="color: var(--primary);">' + t('autoDetect.getExtensionLink') + '</a>.';
                }

                // Re-render dynamic content with translations
                renderPresets();
                updateFallbackStatus();

                console.log('[AutoDetect] updateUILanguage completed successfully');
            } catch (error) {
                console.error('[AutoDetect] updateUILanguage error:', error);
            }
        }

        // Listen for language changes
        ipcRenderer.on('language-changed', (event, lang) => {
            loadTranslationsLocal(lang);
            updateUILanguage();
        });

        // Open external links in default browser
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'getExtensionLink') {
                e.preventDefault();
                shell.openExternal(e.target.href);
            }
        });
    </script>
</body>

</html>